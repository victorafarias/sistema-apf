{% extends "base.html" %}

{% block title %}Editar Contagem{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Editar Contagem: {{ contagem.descricao }}</h6>
    </div>
    <div class="card-body">

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="identificacao-tab" data-toggle="tab" href="#identificacao" role="tab" aria-controls="identificacao" aria-selected="true">1. Identificação</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="funcoes-tab" data-toggle="tab" href="#funcoes" role="tab" aria-controls="funcoes" aria-selected="false">2. Funções</a>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="identificacao" role="tabpanel" aria-labelledby="identificacao-tab">
                <form action="/contagens/{{ contagem.id }}/editar" method="post" class="mt-4">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="cliente_id">Cliente</label>
                            <select id="cliente_id" name="cliente_id" class="form-control" required>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" {% if cliente.id == contagem.cliente_id %}selected{% endif %}>{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="projeto_id">Projeto</label>
                            <select id="projeto_id" name="projeto_id" class="form-control" required disabled>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="sistema_id">Sistema</label>
                            <select id="sistema_id" name="sistema_id" class="form-control" disabled>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="descricao">Descrição da Contagem</label>
                        <input type="text" id="descricao" name="descricao" class="form-control" value="{{ contagem.descricao }}" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="tipo_contagem">Tipo da Contagem</label>
                            <select id="tipo_contagem" name="tipo_contagem" class="form-control" required>
                                {% for tipo in tipos_contagem %}
                                <option value="{{ tipo }}" {% if tipo == contagem.tipo_contagem %}selected{% endif %}>{{ tipo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="metodo_contagem">Método de Contagem</label>
                            <select id="metodo_contagem" name="metodo_contagem" class="form-control" required>
                                {% for metodo in metodos_contagem %}
                                <option value="{{ metodo }}" {% if metodo == contagem.metodo_contagem %}selected{% endif %}>{{ metodo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="data_criacao">Data da Criação</label>
                            <input type="date" id="data_criacao" name="data_criacao" class="form-control" value="{{ contagem.data_criacao[:10] }}" required>
                        </div>
                        <div class="form-group col-md-3">
                             <label for="responsavel">Responsável</label>
                             <input type="text" id="responsavel" name="responsavel" class="form-control" value="{{ contagem.responsavel }}" required>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    <a href="/contagens" class="btn btn-secondary">Cancelar</a>
                </form>
            </div>

            <div class="tab-pane fade" id="funcoes" role="tabpanel" aria-labelledby="funcoes-tab">
                <div class="card-body">
                    
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Funções da Contagem</h1>
                        <button type="button" class="btn btn-primary shadow-sm" data-toggle="modal" data-target="#importModal">
                            <i class="fas fa-upload fa-sm text-white-50"></i> Importar Funções
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered" id="dataTableFuncoes" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>DER</th>
                                    <th>Desc. DER</th>
                                    <th>ALR/RLR</th>
                                    <th>Desc. ALR/RLR</th>
                                    <th>Complexidade</th>
                                    <th>PF Bruto</th>
                                    <th>PF Líquido</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for funcao in funcoes %}
                                <tr>
                                    <td>{{ funcao.nome }}</td>
                                    <td>{{ funcao.tipo_funcao.value }}</td>
                                    <td>{{ funcao.qtde_der.value }}</td>
                                    <td>{{ funcao.desc_der.value }}</td>
                                    <td>{{ funcao.qtde_rlr.value }}</td>
                                    <td>{{ funcao.desc_rlr.value }}</td>
                                    <td>{{ funcao.complexidade or 'N/A' }}</td>
                                    <td>{{ funcao.ponto_de_funcao_bruto or 'N/A' }}</td>
                                    <td>{{ funcao.ponto_de_funcao_liquido or 'N/A' }}</td>
                                    <td>
                                        </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="10" class="text-center">Nenhuma função importada para esta contagem ainda.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Importar Funções da Planilha</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="step1">
                    <h6>Etapa 1 de 4: Enviar Planilha</h6>
                    <p>Arraste e solte o arquivo .xlsx ou clique na área abaixo para selecionar.</p>
                    <div id="drop-area" style="border: 2px dashed #ccc; border-radius: 5px; padding: 50px; text-align: center; cursor: pointer;">
                        <p>Arraste seu arquivo aqui</p>
                        <i class="fas fa-upload fa-3x text-gray-300"></i>
                    </div>
                    <input type="file" id="fileElem" accept=".xlsx" style="display:none">
                    <div id="upload-progress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                                Processando...
                            </div>
                        </div>
                    </div>
                    <div id="step1-error" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>

                <div id="step2" style="display: none;">
                    <h6>Etapa 2 de 4: Validar Fatores de Ajuste</h6>
                    <div id="step2-loader" class="text-center my-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Validando...</span>
                        </div>
                        <p>Validando fatores de ajuste...</p>
                    </div>
                    <div id="step2-content" style="display: none;">
                        <p>Encontramos alguns "Tipos de Projeto" na sua planilha que não existem no sistema. Por favor, complete as informações abaixo para cadastrá-los.</p>
                        <form id="fatores-form">
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead>
                                        <tr>
                                            <th>Tipo de Projeto (da Planilha)</th>
                                            <th>Fator (da Planilha)</th>
                                            <th>Tipo de Ajuste (Selecione)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fatores-novos-table">
                                        </tbody>
                                </table>
                            </div>
                        </form>
                        <div id="step2-sem-novos" class="alert alert-success" style="display: none;">
                            <i class="fas fa-check-circle"></i> Todos os Fatores de Ajuste da planilha já existem no sistema.
                        </div>
                    </div>
                    <div id="step2-error" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
                <div id="step3" style="display: none;">
                    <h6>Etapa 3 de 4: Mapear Colunas</h6>
                    <p>Associe as colunas da sua planilha aos campos do sistema. O sistema tentou adivinhar os melhores mapeamentos, mas por favor, verifique todos os campos.</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="thead-light">
                                <tr>
                                    <th>Campo do Sistema</th>
                                    <th>Coluna da sua Planilha</th>
                                </tr>
                            </thead>
                            <tbody id="mapping-table-body">
                                </tbody>
                        </table>
                    </div>
                    <div id="step3-error" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="nextButton" disabled>Avançar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', async function () {
    // --- SEÇÃO 1: LÓGICA EXISTENTE DOS SELECTS (CLIENTE/PROJETO/SISTEMA) ---
    const clienteSelect = document.getElementById('cliente_id');
    const projetoSelect = document.getElementById('projeto_id');
    const sistemaSelect = document.getElementById('sistema_id');
    const apiBaseUrl = '/api';

    const initialData = {
        clienteId: {{ contagem.cliente_id }},
        projetoId: {{ contagem.projeto_id }},
        sistemaId: {{ contagem.sistema_id or 'null' }}
    };

    async function populateSelect(selectElement, items, placeholder, selectedId = null, optional = false) {
        selectElement.innerHTML = '';
        if (optional) {
            selectElement.innerHTML = `<option value="">Nenhum (Opcional)</option>`;
        } else {
            selectElement.innerHTML = `<option value="" disabled>${placeholder}</option>`;
        }
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.nome;
            if (item.id === selectedId) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
        selectElement.disabled = false;
    }

    async function loadProjetos(clienteId, selectedProjetoId = null) {
        if (!clienteId) return;
        projetoSelect.disabled = true;
        projetoSelect.innerHTML = '<option value="">Carregando...</option>';
        sistemaSelect.disabled = true;
        sistemaSelect.innerHTML = '<option value="">Selecione um projeto primeiro...</option>';
        try {
            const response = await fetch(`${apiBaseUrl}/projetos/cliente/${clienteId}`);
            const projetos = await response.json();
            populateSelect(projetoSelect, projetos, 'Selecione um projeto...', selectedProjetoId);
            if (selectedProjetoId) {
                await loadSistemas(selectedProjetoId, initialData.sistemaId);
            } else if (projetos.length > 0) {
                const firstId = String(projetos[0].id);
                projetoSelect.value = firstId;
                await loadSistemas(firstId);
            } else {
                sistemaSelect.innerHTML = '<option value="">Nenhum (Opcional)</option>';
                sistemaSelect.disabled = false;
            }
        } catch (error) {
            console.error('Erro ao carregar projetos:', error);
        }
    }

    async function loadSistemas(projetoId, selectedSistemaId = null) {
        if (!projetoId) {
            sistemaSelect.innerHTML = '<option value="">Nenhum (Opcional)</option>';
            sistemaSelect.disabled = false;
            return;
        }
        try {
            const response = await fetch(`${apiBaseUrl}/sistemas/projeto/${projetoId}`);
            const sistemas = await response.json();
            populateSelect(sistemaSelect, sistemas, 'Selecione um sistema...', selectedSistemaId, true);
        } catch (error) {
            console.error('Erro ao carregar sistemas:', error);
        }
    }

    clienteSelect.addEventListener('change', () => {
        loadProjetos(clienteSelect.value);
        sistemaSelect.innerHTML = '<option value="">Selecione um projeto primeiro...</option>';
        sistemaSelect.disabled = true;
    });

    projetoSelect.addEventListener('change', () => {
        loadSistemas(projetoSelect.value);
    });

    if (initialData.clienteId) {
        await loadProjetos(initialData.clienteId, initialData.projetoId);
    }

    // =======================================================================
    // SEÇÃO 2: LÓGICA DA MODAL DE IMPORTAÇÃO (INTEGRADA)
    // =======================================================================

    let importData = {};
    const contagemId = {{ contagem.id }};
    const modal = $('#importModal');
    
    const dropArea = document.getElementById('drop-area');
    const fileElem = document.getElementById('fileElem');
    const nextButton = document.getElementById('nextButton');
    const step1Div = document.getElementById('step1');
    const step2Div = document.getElementById('step2');
    const step3Div = document.getElementById('step3');
    const step1Error = document.getElementById('step1-error');
    const step2Error = document.getElementById('step2-error');
    const step3Error = document.getElementById('step3-error');
    const step2Loader = document.getElementById('step2-loader');
    const step2Content = document.getElementById('step2-content');
    const step2SemNovos = document.getElementById('step2-sem-novos');
    const fatoresNovosTable = document.getElementById('fatores-novos-table');

    function fetchWithTimeout(url, options, timeout = 30000) { // Timeout aumentado para 30s
        console.log(`[DEBUG] Iniciando fetch para: ${url}`, options);
        return Promise.race([
            fetch(url, options),
            new Promise((_, reject) =>
                setTimeout(() => reject(new Error('A requisição demorou muito para responder (timeout). Verifique o console do servidor para erros.')), timeout)
            )
        ]);
    }

    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, preventDefaults, false));
    ['dragenter', 'dragover'].forEach(e => dropArea.addEventListener(e, () => dropArea.style.borderColor = 'blue', false));
    ['dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, () => dropArea.style.borderColor = '#ccc', false));
    
    dropArea.addEventListener('drop', handleDrop, false);
    dropArea.addEventListener('click', () => fileElem.click());
    fileElem.addEventListener('change', function() { if (this.files.length > 0) handleFiles(this.files); });

    function handleDrop(e) { handleFiles(e.dataTransfer.files); }

    function handleFiles(files) {
        if (files.length > 1) { showError('step1', "Apenas um arquivo por vez."); return; }
        const file = files[0];
        if (!file.name.endsWith('.xlsx')) { showError('step1', "Formato inválido. Envie um arquivo .xlsx."); return; }
        uploadFile(file);
    }

    function uploadFile(file) {
        showLoader('step1');
        let formData = new FormData();
        formData.append('file', file);

        fetchWithTimeout(`/api/funcoes/contagem/${contagemId}/upload_step1`, { method: 'POST', body: formData })
        .then(handleFetchResponse)
        .then(data => {
            console.log('[DEBUG] Sucesso Etapa 1:', data);
            importData.step1 = data;
            proceedToStep2();
        })
        .catch(error => {
            console.error('[ERRO] Etapa 1:', error);
            showError('step1', error.message);
        })
        .finally(() => hideLoader('step1'));
    }

    function proceedToStep2() {
        step1Div.style.display = 'none';
        step2Div.style.display = 'block';
        showLoader('step2');
        
        fetchWithTimeout(`/api/funcoes/contagem/${contagemId}/validate_step2`, { method: 'POST' })
        .then(handleFetchResponse)
        .then(data => {
            console.log('[DEBUG] Sucesso Validação (Etapa 2):', data);
            importData.step2 = data; 
            
            // Se a lista de novos fatores estiver vazia, avança direto
            if (!data.fatores_novos || data.fatores_novos.length === 0) {
                console.log("[DEBUG] Nenhum fator novo. Avançando para a Etapa 3.");
                
                // Mostra a mensagem de sucesso por um instante
                step2SemNovos.style.display = 'block';
                step2Content.style.display = 'block';
                hideLoader('step2'); // Esconde o spinner
                nextButton.disabled = true;

                // Após um breve momento, avança para a próxima etapa
                setTimeout(() => {
                    proceedToStep3(); // Avança para o mapeamento
                }, 1500); // 1.5 segundos para o usuário ler a mensagem
            } else {
                // Se houver fatores novos, renderiza a tabela para o usuário
                renderStep2(data.fatores_novos);
            }
           
        })
        .catch(error => {
            console.error('[ERRO] Etapa 2:', error);
            showError('step2', error.message);
            hideLoader('step2');
        });
    }

    function renderStep2(fatoresNovos) {
        fatoresNovosTable.innerHTML = ''; 
        
        if (fatoresNovos && fatoresNovos.length > 0) {
            // Se HÁ fatores novos, mostra a tabela para o usuário preencher
            step2SemNovos.style.display = 'none';
            fatoresNovos.forEach(fator => {
                const row = document.createElement('tr');
                row.setAttribute('data-nome-fator', fator.nome);
                row.innerHTML = `<td>${fator.nome}</td><td><input type="number" class="form-control form-control-sm" name="fator_valor" value="${fator.fator || 0.0}" step="0.01"></td><td><select class="form-control form-control-sm" name="tipo_ajuste" required><option value="Percentual">Percentual</option><option value="Unitário">Unitário</option></select></td>`;
                fatoresNovosTable.appendChild(row);
            });
            step2Content.style.display = 'block';
            nextButton.disabled = false;
            nextButton.onclick = processStep2;
        } else {
         
            // Se NÃO HÁ fatores novos, mostra a mensagem de sucesso por um instante e avança automaticamente.
            step2SemNovos.style.display = 'block';
            step2Content.style.display = 'block';
            nextButton.disabled = true; // Mantém o botão desabilitado
            
            console.log("[DEBUG] Nenhum fator novo encontrado. Avançando automaticamente para a Etapa 3 em 2 segundos...");
            
            // Aguarda 2 segundos para o usuário ver a mensagem e então prossegue
            setTimeout(() => {
                proceedToStep3();
            }, 2000); 
           
        }
    }

    function processStep2() {
        showLoader('step2');
        const formRows = fatoresNovosTable.querySelectorAll('tr');
        const novosFatoresPayload = [];
        formRows.forEach(row => {
            novosFatoresPayload.push({
                nome: row.getAttribute('data-nome-fator'),
                fator: parseFloat(row.querySelector('input[name="fator_valor"]').value),
                tipo_ajuste: row.querySelector('select[name="tipo_ajuste"]').value
            });
        fetchWithTimeout(`/api/funcoes/contagem/${contagemId}/create_fatores_step2`, { /* ... */ })
        .then(handleFetchResponse)
        .then(data => {
            console.log("[DEBUG] Fatores criados:", data.message);
            
            // Em vez de um alert, chama a próxima etapa
            proceedToStep3();

        })
        .catch(error => { /* ... */ })
        .finally(() => { /* ... */ });
        });
    
        // --- NOVA LÓGICA DA ETAPA 3 ---

    function proceedToStep3() {
        step2Div.style.display = 'none';
        step3Div.style.display = 'block';
        renderStep3();
    }

    function renderStep3() {
        // Campos do banco de dados que queremos que o usuário mapeie
        const camposDB = [
            { db: 'nome_fator_ajuste', display: 'Tipo Projeto', required: true },
            { db: 'modulo', display: 'Módulo', required: true },
            { db: 'funcionalidade', display: 'Funcionalidade', required: true },
            { db: 'nome', display: 'Nome da Função', required: true },
            { db: 'tipo_funcao', display: 'Tipo (ALI, AIE, etc)', required: true },
            { db: 'qtd_der', display: 'Qtd. DER', required: true },
            { db: 'qtd_rlr', display: 'Qtd. ALR/RLR', required: true },
            { db: 'desc_der', display: 'Descrição DER', required: false },
            { db: 'desc_rlr', display: 'Descrição ALR/RLR', required: false },
            { db: 'insumos', display: 'Insumos', required: false },
            { db: 'observacoes', display: 'Observação', required: false },
        ];
        
        const headersPlanilha = importData.step1.headers;
        mappingTableBody.innerHTML = '';

        camposDB.forEach(campo => {
            const row = document.createElement('tr');
            
            let optionsHTML = '<option value="">-- Ignorar este campo --</option>';
            headersPlanilha.forEach(header => {
                // Tenta encontrar a melhor correspondência inicial
                const isSelected = header.toLowerCase().includes(campo.display.toLowerCase().split(' ')[0]);
                optionsHTML += `<option value="${header}" ${isSelected ? 'selected' : ''}>${header}</option>`;
            });

            const requiredLabel = campo.required ? '<span class="text-danger">*</span>' : '';

            row.innerHTML = `
                <td><label for="map-${campo.db}">${campo.display} ${requiredLabel}</label></td>
                <td>
                    <select id="map-${campo.db}" data-db-field="${campo.db}" class="form-control form-control-sm" ${campo.required ? 'required' : ''}>
                        ${optionsHTML}
                    </select>
                </td>
            `;
            mappingTableBody.appendChild(row);
        });

        nextButton.disabled = false;
        nextButton.onclick = processStep3;
    }

    function processStep3() {
        showLoader('step3'); // Precisaremos adicionar 'step3' a esta função
        const selects = mappingTableBody.querySelectorAll('select');
        const mapeamentoPayload = {};
        let isValid = true;

        selects.forEach(select => {
            const campoDB = select.getAttribute('data-db-field');
            const colunaPlanilha = select.value;

            if (select.required && !colunaPlanilha) {
                isValid = false;
            }

            if (colunaPlanilha) { // Apenas envia se um valor foi selecionado
                mapeamentoPayload[colunaPlanilha] = campoDB;
            }
        });

        if (!isValid) {
            showError('step3', 'Por favor, mapeie todos os campos obrigatórios (*).');
            hideLoader('step3');
            return;
        }

        console.log('[DEBUG] Enviando mapeamento:', mapeamentoPayload);

        fetchWithTimeout(`/api/funcoes/contagem/${contagemId}/process_mapping_step3`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(mapeamentoPayload)
        })
        .then(handleFetchResponse)
        .then(data => {
            console.log('[DEBUG] Sucesso Mapeamento (Etapa 3):', data);
            importData.step3 = data;
            
            step3Div.style.display = 'none';
            // document.getElementById('step4').style.display = 'block'; // Próxima etapa
            alert("Etapa 3 Concluída! Próximo passo: Pré-visualização.");
        })
        .catch(error => {
            console.error('[ERRO] Etapa 3:', error);
            showError('step3', error.message);
        })
        .finally(() => hideLoader('step3'));
    }

        console.log('[DEBUG] Enviando novos fatores:', novosFatoresPayload);
        fetchWithTimeout(`/api/funcoes/contagem/${contagemId}/create_fatores_step2`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(novosFatoresPayload),
        })
        .then(handleFetchResponse)
        .then(data => {
            console.log("[DEBUG] Fatores criados:", data.message);
            step2Div.style.display = 'none';
            alert("Etapa 2 concluída! Próximo passo: Mapeamento de Colunas.");
        })
        .catch(error => {
            console.error('[ERRO] Processar Etapa 2:', error);
            showError('step2', error.message);
        })
        .finally(() => hideLoader('step2'));
    }

    function showLoader(step) {
        if (step === 'step1') {
            document.getElementById('upload-progress').style.display = 'block';
            nextButton.disabled = true;
            step1Error.style.display = 'none';
        } else if (step === 'step2') {
            step2Loader.style.display = 'block';
            step2Content.style.display = 'none';
            nextButton.disabled = true;
            step2Error.style.display = 'none';
        }
    }

    function hideLoader(step) {
        if (step === 'step1') {
            document.getElementById('upload-progress').style.display = 'none';
        } else if (step === 'step2') {
            step2Loader.style.display = 'none';
        }
    }

    function showError(step, message) {
        const errorDiv = document.getElementById(`${step}-error`);
        if(errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    }

    function handleFetchResponse(response) {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || 'Ocorreu um erro desconhecido.') });
        }
        return response.json();
    }

    modal.on('hidden.bs.modal', function () {
        step1Div.style.display = 'block';
        step2Div.style.display = 'none';
        step1Error.style.display = 'none';
        step2Error.style.display = 'none';
        step2Content.style.display = 'none';
        fileElem.value = '';
        nextButton.disabled = true;
        nextButton.onclick = null;
        importData = {};
    });
});
</script>
{% endblock %}